<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Profil Guilde | FF GuildwarsBattles2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#000,#2c2c2c);
  color:#fff;
  text-align:center;
}
header{
  background:rgba(0,0,0,0.7);
  padding:20px;
  text-align:center;
  border-bottom:1px solid rgba(255,255,255,0.15);
}
header h1{
  margin:0;
  font-size:1.8rem;
  background:linear-gradient(90deg,#fff,#aaa);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.container{
  max-width:700px;
  margin:30px auto;
  background:rgba(255,255,255,0.08);
  border-radius:18px;
  padding:25px;
  box-shadow:0 0 25px rgba(0,170,255,0.25);
  text-align:center;
}
.guild-logo{
  width:150px;
  height:150px;
  border-radius:50%;
  border:4px solid #00aaff;
  margin:0 auto 15px;
  object-fit:cover;
}
.guild-name{
  font-size:1.6rem;
  font-weight:bold;
  margin-bottom:10px;
  padding:8px 12px;
  border:2px solid #ff0000;
  display:inline-block;
  border-radius:12px;
  background:rgba(255,0,0,0.08);
}
.guild-badge{
  width:28px;
  height:28px;
  margin-left:8px;
  vertical-align:middle;
  border-radius:50%;
}
.guild-level{
  margin-bottom:15px;
  font-size:1.1rem;
  color:#00ffcc;
}
button{
  padding:8px 12px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  margin:5px;
  font-size:0.9rem;
}
.addPlayerBtn{
  background:rgba(255,0,0,0.3);
  color:#fff;
}
.changeLogoBtn{
  background:#00aaff;
  color:#000;
  font-weight:bold;
  margin-bottom:15px;
}
.player-module{
  background:rgba(255,0,0,0.1);
  border:2px solid rgba(255,0,0,0.3);
  border-radius:12px;
  padding:10px;
  margin-top:10px;
  display:none;
  text-align:left;
}
.player-module b{
  color:#fff;
}
.player-card{
  background:rgba(255,0,0,0.1);
  border:2px solid rgba(255,0,0,0.3);
  border-radius:12px;
  padding:6px 10px;
  margin-top:6px;
  text-align:left;
  font-size:0.85rem;
  opacity:0.85;
  position:relative;
}
.player-badge{
  width:20px;
  height:20px;
  vertical-align:middle;
  margin-left:6px;
  border-radius:50%;
}
#logoPreview{
  display:block;
  margin:10px auto;
  width:120px;
  height:120px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #00aaff;
}
.badgeCodeBtn{
  background:#444;
  color:#fff;
  font-size:0.8rem;
  padding:4px 6px;
  border-radius:6px;
  margin-left:5px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <h1>üè∞ Profil de la Guilde</h1>
</header>

<div class="container">
  <img id="guildLogo" class="guild-logo" src="https://via.placeholder.com/150" alt="Logo Guilde">
  <div>
    <span id="guildName" class="guild-name">Nom de la Guilde</span>
    <span id="guildBadgeContainer"></span>
    <button class="badgeCodeBtn" onclick="addGuildBadge()">üí†</button>
  </div>

  <div id="guildLevel" class="guild-level">Niveau : 0</div>

  <button class="changeLogoBtn" onclick="document.getElementById('logoInput').click()">üì∏ Changer Logo</button>
  <input type="file" id="logoInput" accept="image/*" style="display:none">
  <img id="logoPreview">

  <button class="addPlayerBtn" onclick="togglePlayerModule()">üë§ Ajouter Joueur</button>

  <div id="playerModule" class="player-module">
    <label>Nom Joueur :</label>
    <input id="playerName" placeholder="Nom du joueur">
    <label>UID :</label>
    <input id="playerUID" placeholder="UID du joueur">
    <label>Niveau :</label>
    <input type="number" id="playerLevel" min="50" placeholder="50">
    <button onclick="addPlayer()">Ajouter</button>
    <button class="badgeCodeBtn" onclick="addPlayerBadge()">üí† Badge Joueur</button>
  </div>

  <h3>Joueurs :</h3>
  <div id="playersList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, arrayUnion, query, collection, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* üî• CONFIG FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026",
  storageBucket: "guildwarsbattles2026.firebasestorage.app",
  messagingSenderId: "116728335274",
  appId: "1:116728335274:web:3a245ad4254caebeb779d3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);

let userUID;
let currentGuildId;

/* üîê AUTH CHECK + R√©cup√®re la guilde de l'utilisateur */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href="index.html";
    return;
  }

  userUID = user.uid;

  const q = query(collection(db,"guildRequests"), where("createdBy","==",userUID));
  const snap = await getDocs(q);

  if(snap.empty){
    alert("Vous n'avez pas de guilde");
    location.href="guildes.html";
    return;
  }

  const guildDoc = snap.docs[0]; 
  currentGuildId = guildDoc.id;

  loadGuild();
});

/* üîê LOAD GUILDE */
async function loadGuild(){
  const docRef = doc(db,"guildRequests",currentGuildId);
  const snap = await getDoc(docRef);
  if(!snap.exists()){
    alert("Guilde non trouv√©e");
    return;
  }

  const guild = snap.data();

  document.getElementById("guildLogo").src = guild.logoURL || "https://via.placeholder.com/150";
  document.getElementById("logoPreview").src = guild.logoURL || "";
  document.getElementById("guildName").textContent = guild.guildName;
  document.getElementById("guildLevel").textContent = "Niveau : "+(guild.level || 0);

  // Badge Guilde
  const badgeContainer = document.getElementById("guildBadgeContainer");
  badgeContainer.innerHTML = "";
  if(guild.badgeCode === "/badge2026xiq"){
    // SVG directement inject√©
    badgeContainer.innerHTML = `
      <svg class="guild-badge" viewBox="0 0 400 400">
        <defs>
          <linearGradient id="redGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#6b0000"/>
            <stop offset="100%" stop-color="#b00000"/>
          </linearGradient>
          <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fff176"/>
            <stop offset="50%" stop-color="#ffb300"/>
            <stop offset="100%" stop-color="#ff6f00"/>
          </linearGradient>
          <linearGradient id="vGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#fff176"/>
            <stop offset="100%" stop-color="#ff9800"/>
          </linearGradient>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="10" result="coloredBlur"/>
            <feMerge>
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        <polygon points="200,20 350,110 350,290 200,380 50,290 50,110"
                 fill="url(#goldGrad)" filter="url(#glow)"/>
        <polygon points="200,50 320,125 320,275 200,350 80,275 80,125"
                 fill="url(#redGrad)"/>
        <path d="M150 120 L200 280 L250 120 L285 120 L220 320 L180 320 L115 120 Z"
              fill="url(#vGrad)" filter="url(#glow)"/>
      </svg>`;
  }

  // Joueurs
  const list = document.getElementById("playersList");
  list.innerHTML="";
  if(guild.players){
    guild.players.forEach(p=>{
      const d = document.createElement("div");
      d.className="player-card";
      d.innerHTML=`<b>${p.name}</b>${p.badgeCode === "/badge2026xiq" ? '<svg class="player-badge" viewBox="0 0 400 400"><polygon points="200,20 350,110 350,290 200,380 50,290 50,110" fill="#FFD700"/></svg>':''} <br> UID: ${p.uid} | Niveau: ${p.level}`;
      list.appendChild(d);
    });
  }
}

/* üîÑ Changement Logo */
document.getElementById("logoInput").onchange = async (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const storageRef = ref(storage, `guildLogos/${currentGuildId}`);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);

  await updateDoc(doc(db,"guildRequests",currentGuildId),{
    logoURL: url
  });

  document.getElementById("guildLogo").src = url;
  document.getElementById("logoPreview").src = url;
}

/* üîÑ Joueurs */
window.togglePlayerModule = ()=>{
  const m = document.getElementById("playerModule");
  m.style.display = m.style.display==="block" ? "none" : "block";
}

window.addPlayer = async ()=>{
  const name = document.getElementById("playerName").value.trim();
  const uid = document.getElementById("playerUID").value.trim();
  const level = Number(document.getElementById("playerLevel").value);

  if(!name || !uid || level<50) return alert("Tous les champs sont obligatoires et niveau >=50");

  await updateDoc(doc(db,"guildRequests",currentGuildId),{
    players: arrayUnion({name, uid, level})
  });

  document.getElementById("playerName").value="";
  document.getElementById("playerUID").value="";
  document.getElementById("playerLevel").value="";
  document.getElementById("playerModule").style.display="none";

  loadGuild();
}

/* üîπ Ajouter Badge Guilde */
window.addGuildBadge = async ()=>{
  const code = prompt("Entrez le code badge de la guilde (ex: /badge2026xiq)");
  if(!code) return;

  await updateDoc(doc(db,"guildRequests",currentGuildId),{
    badgeCode: code
  });
  loadGuild();
}

/* üîπ Ajouter Badge Joueur */
window.addPlayerBadge = async ()=>{
  const name = document.getElementById("playerName").value.trim();
  if(!name) return alert("Nom du joueur requis");

  const code = prompt("Entrez le code badge pour le joueur");
  if(!code) return;

  const docRef = doc(db,"guildRequests",currentGuildId);
  const snap = await getDoc(docRef);
  const guild = snap.data();
  if(!guild.players) return;

  const updatedPlayers = guild.players.map(p=>{
    if(p.name === name){
      p.badgeCode = code;
    }
    return p;
  });

  await updateDoc(docRef,{players: updatedPlayers});
  loadGuild();
}
</script>

</body>
</html>
