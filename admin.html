<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin | FF GuildwarsBattles2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#000,#2c2c2c);
  color:#fff;
}
header{
  background:rgba(0,0,0,0.7);
  padding:20px;
  text-align:center;
  border-bottom:1px solid rgba(255,255,255,0.15);
}
header h1{
  margin:0;
  font-size:1.8rem;
  background:linear-gradient(90deg,#fff,#aaa);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.container{
  max-width:900px;
  margin:30px auto;
  background:rgba(255,255,255,0.08);
  border-radius:18px;
  padding:25px;
  box-shadow:0 0 25px rgba(0,170,255,0.25);
}
.card{
  background:rgba(255,255,255,0.1);
  padding:15px;
  border-radius:14px;
  margin-bottom:15px;
}
button{
  padding:10px 14px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  margin:5px 4px 0 0;
}
.approve{background:#00ff88}
.refuse{background:#ff4d4d}
.delete{background:#000;color:#fff;border:1px solid #666}
.badgeBtn{background:#FFD700}
input,textarea,select{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  margin-top:6px;
  background:rgba(0,0,0,0.6);
  color:#fff;
}
img{max-width:120px;border-radius:12px;margin-top:10px}
</style>
</head>

<body>

<header>
  <h1>üõ°Ô∏è Panel Admin</h1>
</header>

<div class="container">
<h2>üè∞ Demandes de Guildes</h2>
<div id="guildList">Chargement‚Ä¶</div>
</div>

<div class="container">
<h2>üéâ Cr√©ation d‚Äô√©v√©nement</h2>

<label>Titre</label>
<input id="eventTitle">

<label>Date</label>
<input type="date" id="eventDate">

<label>Description</label>
<textarea id="eventDesc"></textarea>

<label>Image</label>
<input type="file" id="eventImg" accept="image/*">
<img id="eventPreview" style="display:none">

<button class="badgeBtn" onclick="createEvent()">Cr√©er l‚Äô√©v√©nement</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, getDocs, doc,
  updateDoc, deleteDoc, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• M√äME CONFIG QUE PROFIL */
const firebaseConfig = {
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026",
  storageBucket: "guildwarsbattles2026.firebasestorage.app",
  messagingSenderId: "116728335274",
  appId: "1:116728335274:web:3a245ad4254caebeb779d3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let adminUID;

/* üîê ACC√àS ADMIN */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href="index.html";
    return;
  }

  const userSnap = await getDocs(collection(db,"users"));
  const userDoc = userSnap.docs.find(d=>d.id===user.uid);

  if(!userDoc || userDoc.data().role !== "admin"){
    alert("Acc√®s r√©serv√© aux administrateurs");
    location.href="profil.html";
    return;
  }

  adminUID = user.uid;
  loadGuilds();
});

/* ================= GUILDES ================= */
async function loadGuilds(){
  const list = document.getElementById("guildList");
  list.innerHTML="";

  const snap = await getDocs(collection(db,"guildRequests"));
  if(snap.empty){
    list.innerHTML="<p>Aucune demande</p>";
    return;
  }

  snap.forEach(d=>{
    const g = d.data();
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <b>${g.guildName}</b><br>
      Chef : ${g.leaderName}<br>
      Statut : ${g.status}<br><br>

      üèÖ Badge V
      <select id="badge-${d.id}">
        <option value="false">NON</option>
        <option value="true">OUI</option>
      </select><br><br>

      <button class="approve" onclick="approve('${d.id}')">Approuver</button>
      <button class="refuse" onclick="refuse('${d.id}')">Refuser</button>
      <button class="delete" onclick="removeGuild('${d.id}')">Supprimer</button>
    `;
    list.appendChild(card);
  });
}

window.approve = async(id)=>{
  const badge = document.getElementById("badge-"+id).value==="true";
  await updateDoc(doc(db,"guildRequests",id),{
    status:"approved",
    badgeV:badge,
    validatedBy:adminUID,
    validatedAt:serverTimestamp()
  });
  loadGuilds();
};

window.refuse = async(id)=>{
  await updateDoc(doc(db,"guildRequests",id),{
    status:"refused",
    validatedBy:adminUID
  });
  loadGuilds();
};

window.removeGuild = async(id)=>{
  if(confirm("Supprimer d√©finitivement ?")){
    await deleteDoc(doc(db,"guildRequests",id));
    loadGuilds();
  }
};

/* ================= EVENTS ================= */
eventImg.onchange = e=>{
  const f = e.target.files[0];
  if(f){
    eventPreview.src = URL.createObjectURL(f);
    eventPreview.style.display="block";
  }
};

window.createEvent = async()=>{
  if(!eventTitle.value || !eventDate.value){
    alert("Champs requis");
    return;
  }

  await addDoc(collection(db,"events"),{
    title:eventTitle.value,
    date:eventDate.value,
    description:eventDesc.value,
    createdBy:adminUID,
    createdAt:serverTimestamp()
  });

  alert("√âv√©nement cr√©√©");
  eventTitle.value="";
  eventDate.value="";
  eventDesc.value="";
  eventPreview.style.display="none";
};
</script>

</body>
</html>
