<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF GuildwarsBattles2026 | Cr√©ation de guilde</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0a0a0a; --card:#1a1a1a; --border:#2e2e2e;
  --text:#e6e6e6; --accent:#9e9e9e;
  --warn:#ff9800;
  --font:'Segoe UI', system-ui;
}
*{box-sizing:border-box;font-family:var(--font)}
body{margin:0;background:var(--bg);color:var(--text)}
header{padding:20px;text-align:center;font-size:22px;font-weight:700;background:#000;border-bottom:1px solid var(--border)}
.container{max-width:1000px;margin:30px auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px}
input,textarea,select,button{
  width:100%;margin:6px 0;padding:10px;
  border-radius:8px;border:1px solid var(--border);
  background:#000;color:var(--text)
}
button{cursor:pointer;font-weight:600;border:none;background:var(--accent);color:#000}
.preview{display:none;margin-top:10px;max-width:150px;border-radius:10px}
.section-title{font-size:20px;margin-bottom:10px;opacity:.85}
.note{font-size:14px;color:var(--warn);margin:5px 0}
.player-box{margin-bottom:10px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#111}
</style>
</head>

<body>

<header id="headerText">FF GuildwarsBattles2026 ‚Äî Cr√©ation de guilde</header>

<div class="container">

<div class="card" id="guildForm">
  <div class="section-title">Cr√©er votre guilde</div>

  <p class="note">‚ö†Ô∏è Niveau minimum des joueurs : 50</p>

  <input type="text" id="guildName" placeholder="Nom de la guilde">
  <input type="text" id="leaderName" placeholder="Nom du chef">
  <input type="text" id="leaderUID" placeholder="UID du chef">

  <input type="file" id="guildLogo" accept="image/*">
  <img id="logoPreview" class="preview">

  <div id="playersContainer"></div>
  <button id="addPlayerBtn">Ajouter un joueur (Max 4)</button>

  <button id="submitGuild">Envoyer la demande</button>
</div>

</div>

<script>
/* üî• FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026"
});

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

/* üîê Connexion obligatoire + v√©rif demande existante */
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="index.html";
    return;
  }

  currentUser = user;

  const snap = await db.collection("guilds")
    .where("ownerUid","==",user.uid)
    .limit(1)
    .get();

  if(!snap.empty){
    location.href="guildStatus.html";
  }
});

/* LOGO */
let guildLogoBase64="";
guildLogo.onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    guildLogoBase64=r.result;
    logoPreview.src=guildLogoBase64;
    logoPreview.style.display="block";
  };
  r.readAsDataURL(f);
};

/* JOUEURS */
let playerCount=0;
addPlayerBtn.onclick=()=>{
  if(playerCount>=4)return alert("Maximum 4 joueurs");
  playerCount++;
  playersContainer.innerHTML+=`
    <div class="player-box">
      <input id="pn${playerCount}" placeholder="Nom joueur ${playerCount}">
      <input id="pu${playerCount}" placeholder="UID joueur ${playerCount}">
    </div>`;
};

/* SOUMISSION */
submitGuild.onclick=async()=>{
  if(!guildName.value||!leaderName.value||!leaderUID.value){
    alert("Champs obligatoires"); return;
  }
  if(!guildLogoBase64){alert("Logo obligatoire"); return;}
  if(playerCount===0){alert("Ajoutez au moins un joueur"); return;}

  const players=[];
  for(let i=1;i<=playerCount;i++){
    const n=document.getElementById("pn"+i).value.trim();
    const u=document.getElementById("pu"+i).value.trim();
    if(!n||!u){alert("Infos joueurs manquantes"); return;}
    players.push({name:n,uid:u,level:50});
  }

  await db.collection("guilds").add({
    ownerUid: currentUser.uid,
    ownerEmail: currentUser.email,
    name: guildName.value,
    leaderName: leaderName.value,
    leaderUID: leaderUID.value,
    logo: guildLogoBase64,
    members: players,
    membersCount: players.length,
    status: "pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  location.href="guildStatus.html";
};
</script>

</body>
</html>
