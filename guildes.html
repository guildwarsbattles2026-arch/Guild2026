<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF GuildwarsBattles2026 | Cr√©ation de guilde</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0a0a0a; --card:#1a1a1a; --border:#2e2e2e;
  --text:#e6e6e6; --accent:#9e9e9e;
  --warn:#ff9800;
  --font:'Segoe UI', system-ui;
}
*{box-sizing:border-box;font-family:var(--font)}
body{margin:0;background:var(--bg);color:var(--text)}
header{padding:20px;text-align:center;font-size:22px;font-weight:700;background:#000;border-bottom:1px solid var(--border)}
.container{max-width:1000px;margin:30px auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px}
input,button{
  width:100%;margin:6px 0;padding:10px;
  border-radius:8px;border:1px solid var(--border);
  background:#000;color:var(--text)
}
button{cursor:pointer;font-weight:600;border:none;background:var(--accent);color:#000}
button:disabled{opacity:.5;cursor:not-allowed}
.preview{display:none;margin-top:10px;max-width:150px;border-radius:10px}
.note{font-size:14px;color:var(--warn)}
.player-box{margin-bottom:10px;padding:10px;border:1px solid var(--border);border-radius:10px}
</style>
</head>

<body>

<header>FF GuildwarsBattles2026 ‚Äî Cr√©ation de guilde</header>

<div class="container">
<div class="card" id="formCard">

  <p class="note">‚ö†Ô∏è Une seule demande autoris√©e par compte</p>

  <input id="guildName" placeholder="Nom de la guilde">
  <input id="leaderName" placeholder="Nom du chef">
  <input id="leaderUID" placeholder="UID du chef">

  <input type="file" id="guildLogo" accept="image/*">
  <img id="logoPreview" class="preview">

  <div id="playersContainer"></div>

  <button type="button" id="addPlayerBtn">Ajouter un joueur (Max 4)</button>
  <button type="button" id="submitGuild">Envoyer la demande</button>

</div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

firebase.initializeApp({
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026"
});

const auth = firebase.auth();
const db = firebase.firestore();

const guildLogo = document.getElementById("guildLogo");
const logoPreview = document.getElementById("logoPreview");
const addPlayerBtn = document.getElementById("addPlayerBtn");
const submitGuild = document.getElementById("submitGuild");
const playersContainer = document.getElementById("playersContainer");
const formCard = document.getElementById("formCard");

let currentUser = null;
let alreadySubmitted = false;
let playerCount = 0;
let guildLogoBase64 = "";

/* üîê AUTH + VERIF */
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="index.html";
    return;
  }

  currentUser = user;

  try{
    const snap = await db.collection("guilds")
      .where("createdBy","==",user.uid)
      .limit(1)
      .get();

    if(!snap.empty){
      alreadySubmitted = true;
      formCard.style.display = "none";
      location.href="guildStatus.html"; // M√™me logique pour les anciens d√©j√† soumis
    }
  }catch(err){
    console.error("Erreur v√©rification Firestore:", err);
  }
});

/* LOGO */
guildLogo.onchange = e=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    guildLogoBase64 = r.result;
    logoPreview.src = guildLogoBase64;
    logoPreview.style.display = "block";
  };
  r.readAsDataURL(f);
};

/* JOUEURS */
addPlayerBtn.onclick = ()=>{
  if(playerCount >=4) return alert("Maximum 4 joueurs");
  playerCount++;
  playersContainer.innerHTML += `
    <div class="player-box">
      <input id="pn${playerCount}" placeholder="Nom joueur ${playerCount}">
      <input id="pu${playerCount}" placeholder="UID joueur ${playerCount}">
    </div>`;
};

/* ENVOI */
submitGuild.onclick = async ()=>{
  if(alreadySubmitted){
    alert("Demande d√©j√† envoy√©e");
    return;
  }

  if(!guildName.value || !leaderName.value || !leaderUID.value || !guildLogoBase64){
    alert("Champs obligatoires manquants");
    return;
  }

  if(playerCount === 0){
    alert("Ajoutez au moins un joueur");
    return;
  }

  const players=[];
  for(let i=1;i<=playerCount;i++){
    const n = document.getElementById("pn"+i).value.trim();
    const u = document.getElementById("pu"+i).value.trim();
    if(!n||!u){
      alert("Infos joueur manquantes");
      return;
    }
    players.push({name:n,uid:u,level:50});
  }

  submitGuild.disabled = true;

  try{
    await db.collection("guilds").add({
      createdBy: currentUser.uid,
      ownerEmail: currentUser.email,
      name: guildName.value,
      leaderName: leaderName.value,
      leaderUID: leaderUID.value,
      logo: guildLogoBase64,
      members: players,
      membersCount: players.length,
      status: "pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alreadySubmitted = true;
    // üîë Redirection vers admin.html apr√®s envoi
    location.href = "admin.html";

  }catch(err){
    console.error(err);
    alert("Erreur lors de l'envoi ‚ùå");
    submitGuild.disabled=false;
  }
};

});
</script>

</body>
</html>
