<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF GuildwarsBattles2026 | Live</title>

<style>
:root{
  --bg:#0a0a0a; --card:#1a1a1a; --border:#2e2e2e;
  --text:#e6e6e6; --accent:#9e9e9e;
  --success:#4caf50; --warn:#ff9800; --danger:#b00020;
  --font:'Segoe UI', system-ui;
}
*{box-sizing:border-box;font-family:var(--font)}
body{margin:0;background:var(--bg);color:var(--text)}
header{
  padding:15px;
  text-align:center;
  font-size:22px;
  font-weight:700;
  background:#000;
  border-bottom:1px solid var(--border);
  position:relative;
}
.record-live{
  position:absolute;
  right:15px;
  top:12px;
  padding:6px 12px;
  border-radius:20px;
  background:#b00020;
  color:#fff;
  font-size:13px;
  font-weight:bold;
  display:none;
  animation:pulse 1.2s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(176,0,32,.6)}
  70%{box-shadow:0 0 0 10px rgba(176,0,32,0)}
  100%{box-shadow:0 0 0 0 rgba(176,0,32,0)}
}
.container{max-width:1200px;margin:20px auto;padding:10px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:15px;margin-bottom:20px}
.inline{display:flex;align-items:center;gap:8px;cursor:pointer;}
.profile-pic{width:60px;height:60px;border-radius:50%;border:2px solid var(--accent)}
.guild-badge{width:48px;height:48px;border-radius:10px;margin-left:8px;border:2px solid var(--accent)}
.guild-member{display:flex;align-items:center;gap:6px;margin:4px 0}
.guild-member img{width:32px;height:32px;border-radius:6px}
.flex-row{display:flex;gap:20px;flex-wrap:wrap}
.live-card{flex:1;min-width:350px;max-width:600px}
.timer{margin-top:6px;font-size:14px;color:#ccc}
.record-info{
  margin-top:10px;
  font-size:14px;
  color:#ffb3b3;
}
.slot-card{background:#1a1a1a;border:1px solid #2e2e2e;border-radius:12px;padding:12px;margin-bottom:15px}
.slot-header{font-weight:bold;margin-bottom:6px}
.slot-empty{color:#777;font-style:italic}
.slot-player{margin-left:10px;font-size:14px}
</style>
</head>

<body>
<header>
  FF GuildwarsBattles2026 â€” LIVE
  <div id="recordBadge" class="record-live">ðŸ”´ RECORD LIVE</div>
</header>

<div class="container">

  <!-- PROFIL CONNECTÃ‰ -->
  <div class="card inline" id="userProfile">
    <img id="profilePic" class="profile-pic" src="" alt="Profil">
    <div>
      <b id="profileName">Nom Membre</b><br>
      <span id="profileEmail"></span>
    </div>
  </div>

  <!-- RECORD LIVE SLOTS -->
  <div class="card" id="recordSlotsCard">
    <b>ðŸŽ¥ Sessions de Record</b>
    <div id="slotsContainer">
      <div class="slot-card" id="slot1"><div class="slot-header">Slot 1</div><div class="slot-empty">Libre</div></div>
      <div class="slot-card" id="slot2"><div class="slot-header">Slot 2</div><div class="slot-empty">Libre</div></div>
    </div>
  </div>

  <!-- MA GUILDE -->
  <div class="card" id="myGuildCard">
    <div class="section-title">Ma Guilde</div>
    <div id="myGuildContent"></div>
  </div>

  <!-- AFFRONTEMENTS LIVE -->
  <div class="flex-row" id="liveBattles"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ CONFIG FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026",
  storageBucket: "guildwarsbattles2026.firebasestorage.app",
  messagingSenderId: "116728335274",
  appId: "1:116728335274:web:3a245ad4254caebeb779d3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== CONNEXION ===== */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href="index.html";
    return;
  }

  profilePic.src = user.photoURL || "https://via.placeholder.com/60";
  profileName.textContent = user.displayName || "Membre";
  profileEmail.textContent = user.email;

  userProfile.onclick = ()=> location.href="profil.html";

  loadMyGuild(user.uid);
  loadLiveBattles();
  listenRecordLiveSlots();
});

/* ================= RECORD LIVE SLOTS ================= */
function listenRecordLiveSlots(){
  const ref = doc(db,"liveRecord","current");

  onSnapshot(ref, snap=>{
    const data = snap.exists() ? snap.data() : {slots:[]};
    const slots = data.slots || [];

    [0,1].forEach(i=>{
      const slotDiv = document.getElementById(`slot${i+1}`);
      slotDiv.innerHTML = `<div class="slot-header">Slot ${i+1}</div>`;

      if(slots[i]){
        const g = slots[i].guildData || {};
        let html = `<div>Guilde: <b>${g.guildName||"N/A"}</b></div>`;
        html += `<div>Chef UID: ${g.leaderUID||"N/A"}</div>`;
        html += `<div>Joueurs:</div>`;
        slots[i].guildData?.players?.forEach(p=>{
          html += `<div class="slot-player">- ${p.name} (UID: ${p.uid})</div>`;
        });
        html += `<div class="record-info">UtilisÃ© par: ${slots[i].userName}</div>`;
        slotDiv.innerHTML += html;
      } else {
        slotDiv.innerHTML += `<div class="slot-empty">Libre</div>`;
      }
    });

    // Badge rouge si au moins un slot actif
    recordBadge.style.display = slots.some(s=>s)? "block":"none";
  });
}

/* ================= MA GUILDE ================= */
async function loadMyGuild(uid){
  const q = query(collection(db,"guilds"), where(`members.${uid}.status`,"==","approved"));
  const snap = await getDocs(q);

  if(snap.empty){
    myGuildContent.innerHTML = "Vous n'Ãªtes dans aucune guilde.";
    return;
  }

  snap.forEach(doc=>{
    const g = doc.data();
    const badge = g.badge ? `<img class="guild-badge" src="${g.badge}">` : "";
    const membersHTML = Object.entries(g.members).map(([id,m])=>{
      const b = m.badge ? `<img class="guild-badge" src="${m.badge}">` : "";
      return `<div class="guild-member"><b>${m.name || id}</b>${b}</div>`;
    }).join("");

    myGuildContent.innerHTML = `
      <div class="inline"><b>${g.name}</b>${badge}</div>
      <div>${membersHTML}</div>
    `;
  });
}

/* ================= LIVE BATTLES ================= */
async function loadLiveBattles(){
  const q = query(collection(db,"guilds"), where("status","==","approved"));
  const snap = await getDocs(q);
  liveBattles.innerHTML="";

  snap.forEach(doc=>{
    const g = doc.data();
    const badge = g.badge ? `<img class="guild-badge" src="${g.badge}">` : "";
    const membersHTML = Object.entries(g.members).map(([id,m])=>{
      const b = m.badge ? `<img class="guild-badge" src="${m.badge}">` : "";
      return `<div class="guild-member"><b>${m.name || id}</b>${b}</div>`;
    }).join("");

    let timerHTML = "";
    if(g.approvedAt){
      const start = g.approvedAt.seconds ? g.approvedAt.seconds*1000 : g.approvedAt;
      timerHTML = `<div class="timer" data-start="${start}">Temps Ã©coulÃ©: 0s</div>`;
    }

    const card = document.createElement("div");
    card.className="card live-card";
    card.innerHTML = `<div class="inline"><b>${g.name}</b>${badge}</div>${membersHTML}${timerHTML}`;
    liveBattles.appendChild(card);
  });

  setInterval(()=>{
    document.querySelectorAll(".timer").forEach(t=>{
      const start = +t.dataset.start;
      const elapsed = Math.floor((Date.now() - start)/1000);
      t.textContent = `Temps Ã©coulÃ©: ${elapsed}s`;
    });
  },1000);
}
</script>

</body>
</html>
