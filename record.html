<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF GuildwarsBattles2026 | Record</title>

<style>
body{
  margin:0;
  font-family:'Segoe UI',system-ui;
  background:#0a0a0a;
  color:#fff;
  text-align:center;
}
header{
  padding:15px;
  font-size:22px;
  font-weight:700;
  background:#000;
  border-bottom:1px solid #2e2e2e;
}
.container{
  max-width:600px;
  margin:40px auto;
  background:#1a1a1a;
  border-radius:16px;
  padding:25px;
  border:1px solid #2e2e2e;
}
button{
  width:100%;
  padding:16px;
  margin-top:15px;
  border:none;
  border-radius:14px;
  font-weight:bold;
  cursor:pointer;
  font-size:16px;
}
.start{background:#4caf50;color:#000}
.stop{background:#b00020;color:#fff}
.locked{background:#555;color:#aaa;cursor:not-allowed}
.status{
  margin-top:20px;
  font-size:15px;
  color:#ccc;
}
input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  margin-top:10px;
  background:#000;
  color:#fff;
}
.guild-member-input{
  display:flex;
  gap:10px;
  margin-top:8px;
}
.guild-member-input input{
  flex:1;
}
</style>
</head>

<body>

<header>üé• Record LIVE</header>

<div class="container">
  <h2 id="recordTitle">Chargement‚Ä¶</h2>

  <div id="recordForm">
    <h3>Remplir les informations avant d‚Äôenregistrer</h3>
    <input id="guildName" placeholder="Nom de la guilde" required>
    <input id="leaderUID" placeholder="UID du chef" required>
    <div id="playersInputs">
      <div class="guild-member-input">
        <input placeholder="UID joueur 1" required>
        <input placeholder="Nom joueur 1" required>
      </div>
      <div class="guild-member-input">
        <input placeholder="UID joueur 2" required>
        <input placeholder="Nom joueur 2" required>
      </div>
      <div class="guild-member-input">
        <input placeholder="UID joueur 3" required>
        <input placeholder="Nom joueur 3" required>
      </div>
      <div class="guild-member-input">
        <input placeholder="UID joueur 4" required>
        <input placeholder="Nom joueur 4" required>
      </div>
    </div>
    <button id="submitInfoBtn">‚úÖ Valider infos et commencer</button>
  </div>

  <button id="recordBtn" class="locked" style="display:none">V√©rification‚Ä¶</button>

  <button id="startScreenRecord" style="margin-top:15px;background:#2196f3;color:#fff;display:none">üìπ Filmer l'√©cran</button>
  <button id="stopScreenRecord" style="margin-top:10px;background:#f44336;color:#fff;display:none">‚èπÔ∏è Arr√™ter l'enregistrement</button>
  <a id="downloadLink" style="display:none;margin-top:10px;color:#4caf50" download="recording.webm">üíæ T√©l√©charger la vid√©o</a>

  <div class="status" id="recordStatus"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  serverTimestamp,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• CONFIG FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026",
  storageBucket: "guildwarsbattles2026.firebasestorage.app",
  messagingSenderId: "116728335274",
  appId: "1:116728335274:web:3a245ad4254caebeb779d3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const recordRef = doc(db,"liveRecord","current");
let currentUser = null;
let isOwnerSlot1 = false;
let isOwnerSlot2 = false;
let mySlot = null;
let guildData = {};

/* üîê AUTH */
onAuthStateChanged(auth,user=>{
  if(!user) location.href="index.html";
  currentUser = user;
});

/* ===== SUBMIT INFOS ===== */
submitInfoBtn.onclick = async ()=>{
  const gName = guildName.value.trim();
  const lUID = leaderUID.value.trim();
  const playerInputs = Array.from(playersInputs.querySelectorAll(".guild-member-input"));
  const players = [];

  for(const div of playerInputs){
    const uid = div.children[0].value.trim();
    const name = div.children[1].value.trim();
    if(!uid || !name) return alert("Tous les joueurs doivent avoir UID et nom");
    players.push({uid,name});
  }
  if(players.length !==4) return alert("Il faut exactement 4 joueurs");

  guildData = {guildName:gName, leaderUID:lUID, players};

  recordForm.style.display="none";
  recordBtn.style.display="block";
  startScreenRecord.style.display="block";

  checkRecordStatus();
};

/* ===== LIVE LISTENER ===== */
function checkRecordStatus(){
  onSnapshot(recordRef, snap=>{
    const data = snap.exists() ? snap.data() : {slots:[]};
    const slots = data.slots || [];

    let statusText = "";
    let occupiedSlots = 0;

    if(slots[0]) occupiedSlots++;
    if(slots[1]) occupiedSlots++;
    statusText = `${occupiedSlots}/2 sessions en cours`;

    if(slots[0] && slots[0].usedBy === currentUser.uid){
      recordBtn.textContent = "Arr√™ter le record (Slot 1)";
      recordBtn.className = "stop";
      isOwnerSlot1 = true;
      mySlot = 0;
    } else if(slots[1] && slots[1].usedBy === currentUser.uid){
      recordBtn.textContent = "Arr√™ter le record (Slot 2)";
      recordBtn.className = "stop";
      isOwnerSlot2 = true;
      mySlot = 1;
    } else if(occupiedSlots>=2){
      recordBtn.textContent = "Tous les slots occup√©s";
      recordBtn.className = "locked";
      recordBtn.disabled = true;
      mySlot = null;
    } else {
      recordBtn.textContent = "D√©marrer le record";
      recordBtn.className = "start";
      recordBtn.disabled = false;
      mySlot = slots[0] ? 1 : 0;
    }

    recordStatus.textContent = statusText;
  });
}

/* ===== START / STOP RECORD ===== */
recordBtn.onclick = async ()=>{
  if(!currentUser || mySlot===null) return;
  const snap = await onSnapshot(recordRef,()=>{});
  const docData = snap.exists() ? snap.data() : {slots:[]};
  const slots = docData.slots || [];

  if((mySlot===0 && isOwnerSlot1) || (mySlot===1 && isOwnerSlot2)){
    slots[mySlot] = null;
    await setDoc(recordRef,{slots},{merge:true});
    isOwnerSlot1=false; isOwnerSlot2=false; mySlot=null;
    return;
  }

  const slotInfo = {
    usedBy:currentUser.uid,
    userName:currentUser.displayName||"Membre",
    startedAt:serverTimestamp(),
    guildData
  };
  slots[mySlot] = slotInfo;
  await setDoc(recordRef,{slots},{merge:true});
};

/* ===== SCREEN RECORDING ===== */
let mediaRecorder, recordedChunks = [];

startScreenRecord.onclick = async ()=>{
  try{
    const stream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:false});
    mediaRecorder = new MediaRecorder(stream,{mimeType:'video/webm; codecs=vp9'});
    mediaRecorder.ondataavailable = e=>{if(e.data.size>0) recordedChunks.push(e.data);}
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(recordedChunks,{type:'video/webm'});
      recordedChunks=[];
      const url = URL.createObjectURL(blob);
      downloadLink.href = url;
      downloadLink.style.display="block";
    };
    mediaRecorder.start();
    startScreenRecord.style.display="none";
    stopScreenRecord.style.display="block";
    recordStatus.textContent += " | üé¨ Enregistrement √©cran actif";
  }catch(err){
    alert("Impossible de capturer l'√©cran : "+err);
  }
};

stopScreenRecord.onclick = ()=>{
  if(mediaRecorder && mediaRecorder.state!=="inactive"){
    mediaRecorder.stop();
    stopScreenRecord.style.display="none";
    startScreenRecord.style.display="block";
    recordStatus.textContent = recordStatus.textContent.replace(" | üé¨ Enregistrement √©cran actif","");
  }
};
</script>

</body>
</html>
