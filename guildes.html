<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Demande de Guilde | FF GuildwarsBattles2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#000,#2c2c2c);
  color:#fff;
}
header{
  background:rgba(0,0,0,0.7);
  padding:20px;
  text-align:center;
  border-bottom:1px solid rgba(255,255,255,0.15);
}
header h1{
  margin:0;
  font-size:1.8rem;
  background:linear-gradient(90deg,#fff,#aaa);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.container{
  max-width:420px;
  margin:40px auto;
  background:rgba(255,255,255,0.08);
  border-radius:18px;
  padding:25px;
  box-shadow:0 0 25px rgba(0,170,255,0.25);
}
label{display:block;margin-top:12px}
input,button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  margin-top:6px;
}
input{
  background:rgba(0,0,0,0.6);
  color:#fff;
}
button{
  background:#00aaff;
  color:#000;
  font-weight:bold;
  cursor:pointer;
  margin-top:18px;
}
button:disabled{opacity:0.6}
.player{
  margin-top:15px;
  padding:12px;
  background:rgba(255,255,255,0.08);
  border-radius:14px;
}
#logoPreview{
  width:120px;
  border-radius:14px;
  margin-top:10px;
  display:none;
}
</style>
</head>

<body>

<header>
  <h1>üè∞ Demande de Guilde</h1>
</header>

<div class="container">
<form id="guildForm">

<label>Nom de la guilde</label>
<input id="guildName" required>

<label>Nom du chef</label>
<input id="leaderName" required>

<label>UID du chef</label>
<input id="leaderUID" required placeholder="UID du chef Free Fire">

<label>Logo de la guilde</label>
<input type="file" id="logo" accept="image/*" required>
<img id="logoPreview">

<h3>üë• Joueurs (1 √† 4)</h3>
<div id="players"></div>

<button type="button" onclick="addPlayer()">‚ûï Ajouter joueur</button>
<button id="submitBtn">üì® Envoyer la demande</button>

</form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc,
  query, where, getDocs, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• CONFIG FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026",
  storageBucket: "guildwarsbattles2026.firebasestorage.app",
  messagingSenderId: "116728335274",
  appId: "1:116728335274:web:3a245ad4254caebeb779d3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userUID;
let playerCount = 0;

/* üîê AUTH + V√âRIF DEMANDE EXISTANTE */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href="index.html";
    return;
  }

  userUID = user.uid;

  // Ne plus forcer leaderUID, il est maintenant modifiable
  leaderName.value = user.displayName || "";

  const q = query(
    collection(db,"guildRequests"),
    where("createdBy","==",user.uid)
  );
  const snap = await getDocs(q);

  if(!snap.empty){
    location.href="guildStatus.html";
  }
});

/* üëÅÔ∏è PREVIEW LOGO */
logo.onchange = e=>{
  const f = e.target.files[0];
  if(f){
    logoPreview.src = URL.createObjectURL(f);
    logoPreview.style.display="block";
  }
};

/* ‚ûï AJOUT JOUEUR */
window.addPlayer = ()=>{
  if(playerCount>=4) return alert("Maximum 4 joueurs");
  playerCount++;

  const d = document.createElement("div");
  d.className="player";
  d.innerHTML=`
    <label>Nom joueur ${playerCount}</label>
    <input class="pname" required>
    <label>UID joueur</label>
    <input class="puid" required>
    <label>Niveau (min 50)</label>
    <input type="number" min="50" class="plevel" required>
  `;
  players.appendChild(d);
};

/* üì§ ENVOI */
guildForm.onsubmit = async e=>{
  e.preventDefault();
  submitBtn.disabled = true;

  const playersData = [];
  document.querySelectorAll(".player").forEach(p=>{
    const level = Number(p.querySelector(".plevel").value);
    if(level < 50) throw alert("Niveau minimum 50");
    playersData.push({
      name:p.querySelector(".pname").value,
      uid:p.querySelector(".puid").value,
      level
    });
  });

  if(playersData.length < 1){
    submitBtn.disabled=false;
    return alert("Ajoute au moins 1 joueur");
  }

  await addDoc(collection(db,"guildRequests"),{
    guildName:guildName.value,
    leaderName:leaderName.value,
    leaderUID:leaderUID.value, // Maintenant r√©cup√©r√© depuis le champ modifiable
    players:playersData,
    createdBy:userUID,
    status:"pending",
    badgeV:false,
    createdAt:serverTimestamp()
  });

  location.href="guildStatus.html";
};
</script>

</body>
</html>
