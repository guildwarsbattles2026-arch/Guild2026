<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF GuildwarsBattles2026 | Admin</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
  --bg:#0a0a0a; --card:#1a1a1a; --border:#2e2e2e;
  --text:#e6e6e6; --accent:#9e9e9e;
  --success:#4caf50; --warn:#ff9800; --danger:#b00020;
  --font:'Segoe UI', system-ui;
}
*{box-sizing:border-box;font-family:var(--font)}
body{margin:0;background:var(--bg);color:var(--text)}
header{padding:20px;text-align:center;font-size:22px;font-weight:700;background:#000;border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:30px auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:25px}
.section-title{font-size:20px;margin:25px 0 15px;opacity:.85}
input,textarea,select{
  width:100%;margin:6px 0;padding:10px;
  background:#000;color:var(--text);
  border:1px solid var(--border);border-radius:8px
}
button{
  padding:10px 16px;border:none;border-radius:10px;
  font-weight:600;cursor:pointer;margin-right:6px
}
.approve{background:var(--success);color:#000}
.refuse{background:var(--warn);color:#000}
.delete{background:var(--danger);color:#fff}
.inline{display:flex;gap:10px;align-items:center}
img{max-width:100%}
</style>
</head>

<body>

<header>FF GuildwarsBattles2026 â€” ADMIN PANEL</header>

<div class="container">

<!-- ================= EVENTS ================= -->
<div class="card">
  <div class="section-title">CrÃ©er un Ã©vÃ©nement</div>

  <input id="eventTitle" placeholder="Nom de l'Ã©vÃ©nement">
  <input type="date" id="eventDate">
  <textarea id="eventDesc" placeholder="Description"></textarea>

  <input type="file" id="eventImage" accept="image/*">
  <img id="eventPreview" style="display:none;margin-top:10px;border-radius:12px">

  <button class="approve" id="createEvent">Ajouter l'Ã©vÃ©nement</button>
</div>

<div class="section-title">Ã‰vÃ©nements</div>
<div id="eventList"></div>

<!-- ================= GUILDES ================= -->
<div class="section-title">Gestion des guildes</div>
<div id="guildList"></div>

</div>

<script>
/* ðŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ðŸ” ADMIN CHECK */
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="index.html";

  const snap = await db.collection("users").doc(user.uid).get();
  if(!snap.exists || snap.data().role !== "admin"){
    alert("â›” AccÃ¨s refusÃ©");
    return location.href="live.html";
  }

  loadEvents();
  loadGuilds();
});

/* ================= EVENTS ================= */
let eventImageBase64 = "";

eventImage.onchange = e=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    eventImageBase64 = r.result;
    eventPreview.src = eventImageBase64;
    eventPreview.style.display = "block";
  };
  r.readAsDataURL(f);
};

createEvent.onclick = async ()=>{
  if(!eventTitle.value || !eventDate.value){
    alert("Titre et date obligatoires");
    return;
  }

  await db.collection("events").add({
    title: eventTitle.value,
    date: eventDate.value,
    description: eventDesc.value,
    image: eventImageBase64 || "",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  eventTitle.value="";
  eventDate.value="";
  eventDesc.value="";
  eventImageBase64="";
  eventPreview.style.display="none";

  loadEvents();
};

async function loadEvents(){
  eventList.innerHTML="";
  const snap = await db.collection("events").orderBy("createdAt","desc").get();

  snap.forEach(doc=>{
    const e = doc.data();
    eventList.innerHTML += `
      <div class="card">
        <b>${e.title}</b><br>
        ðŸ“… ${e.date}<br>
        <small>${e.description || ""}</small><br><br>
        ${e.image ? `<img src="${e.image}" style="border-radius:12px;margin-bottom:10px">` : ""}
        <button class="delete" onclick="deleteEvent('${doc.id}')">Supprimer</button>
      </div>
    `;
  });
}

async function deleteEvent(id){
  if(!confirm("Supprimer cet Ã©vÃ©nement ?")) return;
  await db.collection("events").doc(id).delete();
  loadEvents();
}

/* ================= GUILDES ================= */
async function loadGuilds(){
  guildList.innerHTML="";
  const snap = await db.collection("guilds").orderBy("createdAt","desc").get();

  snap.forEach(doc=>{
    const g = doc.data();

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="inline">
        <img src="${g.logo}" width="60" style="border-radius:10px">
        <div>
          <b>${g.name}</b><br>
          Statut : <b>${g.status}</b>
        </div>
      </div>

      <br>
      <b>Chef :</b> ${g.leaderName}<br>
      <b>UID Chef :</b> ${g.leaderUID}<br>
      <b>Email :</b> ${g.ownerEmail}<br>
      <b>Membres :</b> ${g.membersCount}

      <ul>
        ${g.members.map(m=>`<li>${m.name} â€” UID ${m.uid}</li>`).join("")}
      </ul>

      Niveau :
      <select id="lvl_${doc.id}">
        ${[1,2,3,4,5].map(l=>`<option ${g.level==l?"selected":""}>${l}</option>`).join("")}
      </select>

      <br><br>

      <div class="inline">
        <img src="badges/badge_v.png" width="48">
        Badge V :
        <select id="badge_${doc.id}">
          <option value="no">NON</option>
          <option value="yes" ${g.badge?"selected":""}>OUI</option>
        </select>
      </div>

      <br>

      <button class="approve">Approuver</button>
      <button class="refuse">Refuser</button>
      <button class="delete">Supprimer</button>
    `;

    card.querySelector(".approve").onclick = async ()=>{
      const giveBadge = document.getElementById("badge_"+doc.id).value==="yes";
      await db.collection("guilds").doc(doc.id).update({
        status:"approved",
        level:+document.getElementById("lvl_"+doc.id).value,
        badge: giveBadge ? "badges/badge_v.png" : firebase.firestore.FieldValue.delete()
      });
      loadGuilds();
    };

    card.querySelector(".refuse").onclick = async ()=>{
      await db.collection("guilds").doc(doc.id).update({status:"refused"});
      loadGuilds();
    };

    card.querySelector(".delete").onclick = async ()=>{
      if(!confirm("Supprimer dÃ©finitivement cette guilde ?")) return;
      await db.collection("guilds").doc(doc.id).delete();
      loadGuilds();
    };

    guildList.appendChild(card);
  });
}
</script>

</body>
</html>
