<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF GuildwarsBattles2026 | Admin</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
  --bg:#0a0a0a; --card:#1a1a1a; --border:#2e2e2e;
  --text:#e6e6e6; --accent:#9e9e9e;
  --success:#4caf50; --warn:#ff9800; --danger:#b00020;
  --font:'Segoe UI', system-ui;
}
*{box-sizing:border-box;font-family:var(--font)}
body{margin:0;background:var(--bg);color:var(--text)}
header{padding:20px;text-align:center;font-size:22px;font-weight:700;background:#000;border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:30px auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:25px}
.section-title{font-size:20px;margin:25px 0 15px;opacity:.85}
select,button{padding:8px;border-radius:8px}
button{font-weight:600;cursor:pointer;margin-right:6px}
.approve{background:#4caf50;color:#000}
.refuse{background:#ff9800;color:#000}
.delete{background:#b00020;color:#fff}
.badge-box{display:flex;align-items:center;gap:12px;margin:10px 0}
.badge-box img{width:48px;border-radius:10px}
.inline{display:flex;align-items:center;gap:10px}
ul{margin:5px 0 10px 20px}
</style>
</head>

<body>

<header>FF GuildwarsBattles2026 â€” ADMIN PANEL</header>

<div class="container">

<div class="section-title">Gestion des guildes</div>
<div id="guildList"></div>

</div>

<script>
/* ðŸ”¥ FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026"
});

const db = firebase.firestore();
const auth = firebase.auth();

/* ðŸ” ADMIN CHECK */
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="index.html";

  const u = await db.collection("users").doc(user.uid).get();
  if(!u.exists || u.data().role !== "admin"){
    alert("AccÃ¨s refusÃ©");
    return location.href="live.html";
  }

  loadGuilds();
});

/* ================= GUILDES ================= */
async function loadGuilds(){
  guildList.innerHTML="";
  const snap = await db.collection("guilds").orderBy("createdAt","desc").get();

  snap.forEach(doc=>{
    const g = doc.data();

    const card = document.createElement("div");
    card.className="card";

    card.innerHTML = `
      <div class="inline">
        <img src="${g.logo}" width="48" style="border-radius:10px">
        <div>
          <b>${g.name}</b><br>
          Statut : <b>${g.status}</b>
        </div>
      </div>

      <br>

      <div><b>Chef :</b> ${g.leaderName}</div>
      <div><b>UID Chef :</b> ${g.leaderUID}</div>
      <div><b>Email :</b> ${g.ownerEmail}</div>
      <div><b>Membres :</b> ${g.membersCount}</div>

      <br>
      <b>Joueurs :</b>
      <ul>
        ${g.members.map(m=>`<li>${m.name} â€” UID ${m.uid}</li>`).join("")}
      </ul>

      <br>

      Niveau :
      <select id="lvl_${doc.id}">
        ${[1,2,3,4,5].map(l=>`
          <option ${g.level==l?"selected":""}>${l}</option>
        `).join("")}
      </select>

      <br><br>

      <div class="badge-box">
        <img src="badges/badge_v.png">
        Donner le badge V ?
        <select id="badge_${doc.id}">
          <option value="no">NON</option>
          <option value="yes" ${g.badge?"selected":""}>OUI</option>
        </select>
      </div>

      <button class="approve">Approuver</button>
      <button class="refuse">Refuser</button>
      <button class="delete">Supprimer</button>
    `;

    /* APPROUVER */
    card.querySelector(".approve").onclick = async ()=>{
      const giveBadge = document.getElementById("badge_"+doc.id).value==="yes";

      await db.collection("guilds").doc(doc.id).update({
        status:"approved",
        level:+document.getElementById("lvl_"+doc.id).value,
        badge: giveBadge ? "badges/badge_v.png" : firebase.firestore.FieldValue.delete()
      });

      loadGuilds();
    };

    /* REFUSER */
    card.querySelector(".refuse").onclick = async ()=>{
      await db.collection("guilds").doc(doc.id).update({status:"refused"});
      loadGuilds();
    };

    /* SUPPRIMER */
    card.querySelector(".delete").onclick = async ()=>{
      if(!confirm("Supprimer dÃ©finitivement cette guilde ?")) return;
      await db.collection("guilds").doc(doc.id).delete();
      loadGuilds();
    };

    guildList.appendChild(card);
  });
}
</script>

</body>
</html>
