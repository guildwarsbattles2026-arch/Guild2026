<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF GuildwarsBattles2026 | Admin</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
  --bg:#0a0a0a; --card:#1a1a1a; --border:#2e2e2e;
  --text:#e6e6e6; --accent:#9e9e9e;
  --success:#4caf50; --warn:#ff9800; --danger:#b00020;
  --font:'Segoe UI', system-ui;
}
*{box-sizing:border-box;font-family:var(--font)}
body{margin:0;background:var(--bg);color:var(--text)}
header{padding:20px;text-align:center;font-size:22px;font-weight:700;background:#000;border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:30px auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:25px}
.section-title{font-size:20px;margin:25px 0 15px;opacity:.85}
input,textarea,select{
  width:100%;margin:6px 0;padding:10px;
  background:#000;color:var(--text);
  border:1px solid var(--border);border-radius:8px
}
button{
  padding:10px 16px;border:none;border-radius:10px;
  font-weight:600;cursor:pointer;margin-right:6px
}
.add-event{background:var(--accent);color:#000}
.approve{background:var(--success);color:#000}
.refuse{background:#ff5252;color:#000}
.suspend{background:var(--warn);color:#000}
.ban{background:var(--danger);color:#fff}
.delete{background:#000;color:#ff5252;border:1px solid #ff5252}
.badges{display:flex;gap:12px;margin:10px 0}
.badges img{
  width:48px;height:48px;border-radius:10px;
  border:2px solid transparent;cursor:pointer
}
.badges img.selected{border-color:var(--accent)}
.inline{display:flex;align-items:center;gap:8px}
</style>
</head>

<body>

<header>FF GuildwarsBattles2026 â€” ADMIN PANEL</header>

<div class="container">

<!-- EVENTS -->
<div class="card">
  <div class="section-title">CrÃ©er un Ã©vÃ©nement</div>
  <input id="eventTitle" placeholder="Nom Ã©vÃ©nement">
  <input type="date" id="eventDate">
  <textarea id="eventDesc" placeholder="Description"></textarea>
  <button class="add-event" id="createEvent">Ajouter</button>
</div>

<div class="section-title">Ã‰vÃ©nements</div>
<div id="eventList"></div>

<div class="section-title">Gestion des guildes</div>
<div id="guildList"></div>

<div class="section-title">Gestion des joueurs</div>
<div id="userList"></div>

</div>

<script>
/* ðŸ”¥ FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyCGuqE5sC6uRppfdsNXLSQEOjvm0doYOr4",
  authDomain: "guildwarsbattles2026.firebaseapp.com",
  projectId: "guildwarsbattles2026",
  storageBucket: "guildwarsbattles2026.firebasestorage.app",
  messagingSenderId: "116728335274",
  appId: "1:116728335274:web:3a245ad4254caebeb779d3"
});

const db = firebase.firestore();
const auth = firebase.auth();

/* ðŸ” SÃ‰CURITÃ‰ ADMIN */
auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="index.html";
    return;
  }

  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();

  if(!snap.exists || snap.data().role !== "admin"){
    alert("â›” AccÃ¨s rÃ©servÃ© aux administrateurs");
    location.href="live.html";
    return;
  }

  loadEvents();
  loadGuilds();
  loadUsers();
});

/* ================= EVENTS ================= */
createEvent.onclick = async ()=>{
  if(!eventTitle.value || !eventDate.value){
    alert("Champs requis");
    return;
  }

  await db.collection("events").add({
    title:eventTitle.value,
    date:eventDate.value,
    description:eventDesc.value,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  eventTitle.value="";
  eventDate.value="";
  eventDesc.value="";
  loadEvents();
};

async function loadEvents(){
  eventList.innerHTML="";
  const snap = await db.collection("events").get();
  snap.forEach(d=>{
    eventList.innerHTML += `
      <div class="card">
        <b>${d.data().title}</b> â€” ${d.data().date}
      </div>
    `;
  });
}

/* ================= GUILDES ================= */
async function loadGuilds(){
  guildList.innerHTML="";
  const snap = await db.collection("guilds").get();

  snap.forEach(doc=>{
    const g = doc.data();
    let selectedBadge = g.badge || "";

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="inline">
        ${g.badge?`<img src="${g.badge}" width="32">`:``}
        <b>${g.name}</b> â€” <i>${g.status || "pending"}</i>
      </div>

      Niveau :
      <select id="lvl_${doc.id}">
        ${[1,2,3,4,5].map(l=>`
          <option ${g.level==l?"selected":""}>${l}</option>
        `).join("")}
      </select>

      <div class="badges">
        ${["badges/badge_v.png","badges/badge1.png","badges/badge2.png"].map(b=>`
          <img src="${b}" data-b="${b}" class="${b==selectedBadge?"selected":""}">
        `).join("")}
      </div>

      <button class="approve">Approuver</button>
      <button class="refuse">Refuser</button>
      <button class="delete">Supprimer</button>
    `;

    card.querySelectorAll("img[data-b]").forEach(img=>{
      img.onclick = ()=>{
        card.querySelectorAll("img").forEach(i=>i.classList.remove("selected"));
        img.classList.add("selected");
        selectedBadge = img.dataset.b;
      };
    });

    /* APPROUVER */
    card.querySelector(".approve").onclick = async ()=>{
      await db.collection("guilds").doc(doc.id).update({
        status:"approved",
        level:+document.getElementById(`lvl_${doc.id}`).value,
        badge:selectedBadge
      });
      loadGuilds();
    };

    /* REFUSER */
    card.querySelector(".refuse").onclick = async ()=>{
      if(!confirm("Refuser cette guilde ?")) return;
      await db.collection("guilds").doc(doc.id).update({
        status:"refused"
      });
      loadGuilds();
    };

    /* SUPPRIMER */
    card.querySelector(".delete").onclick = async ()=>{
      if(!confirm("âš ï¸ SUPPRIMER DÃ‰FINITIVEMENT cette guilde ?")) return;
      await db.collection("guilds").doc(doc.id).delete();
      loadGuilds();
    };

    guildList.appendChild(card);
  });
}

/* ================= USERS ================= */
async function loadUsers(){
  userList.innerHTML="";
  const snap = await db.collection("users").get();

  snap.forEach(doc=>{
    const u = doc.data();
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <b>${u.fullname || ""}</b> (${u.email || ""})
      <br><br>
      RÃ´le :
      <select id="r_${doc.id}">
        <option value="user" ${u.role=="user"?"selected":""}>user</option>
        <option value="admin" ${u.role=="admin"?"selected":""}>admin</option>
      </select>
      <br><br>
      <button class="approve">Sauver</button>
    `;

    card.querySelector(".approve").onclick = ()=>{
      db.collection("users").doc(doc.id).update({
        role: document.getElementById(`r_${doc.id}`).value
      });
    };

    userList.appendChild(card);
  });
}
</script>

</body>
</html>
